<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excavator trench</title>
  <style>
    html, body { height: 100%; margin: 0; background: #8cc7ff; }
    body { overflow: hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #scene { width: 100vw; height: 100vh; display: block; background: linear-gradient(#9dd4ff, #e6f6ff 45%, #e6f6ff 45%, #e6f6ff); }
    .dust { opacity: 0.25; animation: float 4s ease-in-out infinite alternate; }
    @keyframes float { from { transform: translateY(0px); } to { transform: translateY(-6px); } }
    .dirt { transform: translate(var(--x0, 0px), var(--y0, 0px)); animation: dirt-fly 650ms ease-out forwards; will-change: transform, opacity; }
    @keyframes dirt-fly { to { transform: translate(calc(var(--x0, 0px) + 110px), calc(var(--y0, 0px) - 60px)); opacity: 0; } }
    .tread { animation: tread-wiggle 1.2s linear infinite; transform-origin: center; }
    @keyframes tread-wiggle { 0% { transform: translateX(0); } 50% { transform: translateX(-2px); } 100% { transform: translateX(0); } }
    svg, svg * { user-select: none; -webkit-user-select: none; -moz-user-select: none; }
  </style>
</head>
<body>
  <svg id="scene" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice" aria-hidden="true" role="img">
    <defs>
      <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#9dd4ff"/>
        <stop offset="45%" stop-color="#e6f6ff"/>
      </linearGradient>
      <linearGradient id="soil" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#7a5b3e"/>
        <stop offset="35%" stop-color="#6d5239"/>
        <stop offset="70%" stop-color="#5e4632"/>
        <stop offset="100%" stop-color="#4c3a2a"/>
      </linearGradient>
      <linearGradient id="trenchFill" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#3e2d22"/>
        <stop offset="100%" stop-color="#251c15"/>
      </linearGradient>
      <linearGradient id="topSoil" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#5e482f"/>
        <stop offset="100%" stop-color="#4b3a28"/>
      </linearGradient>
    </defs>

    <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>

    <g id="ground">
      <rect id="groundFill" x="0" y="360" width="1000" height="240" fill="url(#soil)"/>
      <rect x="0" y="360" width="1000" height="10" fill="url(#topSoil)"/>
    </g>

    <g id="trench">
      <rect id="trenchRect" x="500" y="360" width="120" height="10" rx="6" ry="6" fill="url(#trenchFill)"/>
      <g opacity="0.55">
        <ellipse class="dust" cx="500" cy="360" rx="8" ry="3" fill="#2a211a"/>
        <ellipse class="dust" cx="620" cy="360" rx="8" ry="3" fill="#2a211a"/>
      </g>
    </g>

    <g id="pileGroup">
      <path id="pile" d="" fill="#5a442e" stroke="#3b2d21" stroke-width="2" />
      <g fill="#4b3726" opacity="0.35">
        <ellipse cx="700" cy="360" rx="8" ry="3"/>
        <ellipse cx="730" cy="360" rx="6" ry="2.5"/>
      </g>
    </g>

    <g id="excavator">
      <g id="tracks">
        <rect x="330" y="320" width="220" height="44" rx="18" ry="18" fill="#2c2c2c" stroke="#1b1b1b" stroke-width="3"/>
        <rect class="tread" x="345" y="326" width="190" height="32" rx="16" ry="16" fill="#3a3a3a"/>
        <g fill="#222">
          <circle cx="380" cy="342" r="12"/><circle cx="420" cy="342" r="12"/>
          <circle cx="460" cy="342" r="12"/><circle cx="500" cy="342" r="12"/>
        </g>
      </g>

      <g id="upper">
        <rect x="400" y="270" width="160" height="50" rx="10" ry="10" fill="#f7c10a" stroke="#8e6b00" stroke-width="3"/>
        <rect x="390" y="280" width="30" height="35" rx="6" ry="6" fill="#e0ab05" stroke="#8e6b00" stroke-width="3"/>
        <g>
          <rect x="450" y="240" width="70" height="40" rx="8" ry="8" fill="#ffd64d" stroke="#8e6b00" stroke-width="3"/>
          <rect x="456" y="246" width="58" height="28" rx="6" ry="6" fill="#88c9ff" stroke="#639ec9" stroke-width="2"/>
        </g>
      </g>

      <g id="boom" transform="translate(500,280) rotate(-20)">
        <path d="M 0 -10 L 130 -6 L 130 6 L 0 10 Z" fill="#ffcc00" stroke="#8e6b00" stroke-width="3"/>
        <rect x="20" y="-5" width="60" height="10" rx="5" ry="5" fill="#d4a700"/>
        <g id="stick" transform="translate(130,0) rotate(35)">
          <path d="M 0 -8 L 120 -4 L 120 4 L 0 8 Z" fill="#ffcc00" stroke="#8e6b00" stroke-width="3"/>
          <g id="bucket" transform="translate(120,0) rotate(90)">
            <path d="M 0 -8 L 28 -8 L 40 0 L 28 12 L 0 8 Z" fill="#4a4a4a" stroke="#2e2e2e" stroke-width="3"/>
            <path d="M 32 0 l 6 8 M 28 3 l 5 7 M 28 -3 l 5 -7" stroke="#2e2e2e" stroke-width="2"/>
          </g>
        </g>
      </g>
    </g>

    <g id="dirtLayer"></g>
  </svg>

  <script>
    const groundY = 360;
    const trenchX = 560;
    const trenchW = 120;
    const xPivot = 500;
    const yPivot = 280;
    const L1 = 130;
    const L2 = 120;
    const L3 = 36;
    const scoopStep = 10;
    const maxDepth  = 200;
    const descendMs = 700;
    const curlMs    = 380;
    const liftMs    = 700;
    const dumpMs    = 420;
    const resetMs   = 320;
    const pauseMs   = 300;

    const gBoom = document.getElementById('boom');
    const gStick = document.getElementById('stick');
    const gBucket = document.getElementById('bucket');
    const trenchRect = document.getElementById('trenchRect');
    const pilePath = document.getElementById('pile');
    const dirtLayer = document.getElementById('dirtLayer');

    let depth = 10;
    let pileHeight = 6;

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const rad2deg = r => r * 180 / Math.PI;
    const lerp = (a, b, t) => a + (b - a) * t;
    const easeInOut = t => (t < 0.5) ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2;

    let currentAngles = { t1: -20, t2: 35, t3: 90 };

    function setAngles(theta1Deg, theta2Deg, theta3Deg) {
      currentAngles = { t1: theta1Deg, t2: theta2Deg, t3: theta3Deg };
      gBoom.setAttribute('transform', `translate(${xPivot},${yPivot}) rotate(${theta1Deg})`);
      gStick.setAttribute('transform', `translate(${L1},0) rotate(${theta2Deg})`);
      gBucket.setAttribute('transform', `translate(${L2},0) rotate(${theta3Deg})`);
    }

    function solveIK(tx, ty) {
      const dx = tx - xPivot;
      const dy = ty - yPivot;
      const r = Math.hypot(dx, dy);
      const rr = clamp(r, Math.abs(L1 - L2) + 0.001, L1 + L2 - 0.001);
      const cos2 = clamp((rr*rr - L1*L1 - L2*L2) / (2 * L1 * L2), -1, 1);
      const theta2 = Math.acos(cos2);
      const k1 = L1 + L2 * Math.cos(theta2);
      const k2 = L2 * Math.sin(theta2);
      const theta1 = Math.atan2(dy, dx) - Math.atan2(k2, k1);
      return { theta1Deg: rad2deg(theta1), theta2Deg: rad2deg(theta2) };
    }

    function animateAngles(from, to, ms) {
      return new Promise(resolve => {
        const t0 = performance.now();
        (function frame(now) {
          const t = clamp((now - t0) / ms, 0, 1);
          const k = easeInOut(t);
          const a1 = lerp(from.t1, to.t1, k);
          const a2 = lerp(from.t2, to.t2, k);
          const a3 = lerp(from.t3, to.t3, k);
          setAngles(a1, a2, a3);
          if (t < 1) requestAnimationFrame(frame); else resolve();
        })(t0);
      });
    }

    function updateTrench(newDepth) {
      const h = clamp(newDepth, 0, 500);
      const x = trenchX - trenchW/2;
      trenchRect.setAttribute('x', x);
      trenchRect.setAttribute('y', groundY);
      trenchRect.setAttribute('width', trenchW);
      trenchRect.setAttribute('height', h);
      depth = h;
    }

    function updatePile(h) {
      pileHeight = h;
      const baseY = groundY;
      const cx = trenchX + 140;
      const w = 120;
      const hh = clamp(h, 0, 160);
      const p = [
        [cx - w, baseY],
        [cx - w*0.6, baseY - hh*0.25],
        [cx - w*0.35, baseY - hh*0.6],
        [cx, baseY - hh],
        [cx + w*0.35, baseY - hh*0.6],
        [cx + w*0.6, baseY - hh*0.25],
        [cx + w, baseY],
      ];
      const d = `M ${p[0][0]} ${p[0][1]} L ${p.slice(1).map(([x,y])=>`${x} ${y}`).join(' ')} Z`;
      pilePath.setAttribute('d', d);
    }

    function flingDirt(n, origin) {
      for (let i = 0; i < n; i++) {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'dirt');
        const jitterX = (Math.random() * 12 - 6);
        const jitterY = (Math.random() * 10 - 5);
        g.style.setProperty('--x0', (origin.x + jitterX) + 'px');
        g.style.setProperty('--y0', (origin.y + jitterY) + 'px');
        const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        c.setAttribute('cx', 0);
        c.setAttribute('cy', 0);
        c.setAttribute('r', 2 + Math.random() * 3);
        c.setAttribute('fill', ['#5a442e', '#4b3726', '#6a5138'][Math.floor(Math.random()*3)]);
        c.setAttribute('opacity', 0.95);
        g.appendChild(c);
        dirtLayer.appendChild(g);
        setTimeout(()=> dirtLayer.contains(g) && dirtLayer.removeChild(g), 900);
      }
    }

    function bucketTipFromAngles(t1, t2, t3) {
      const R1 = t1 * Math.PI / 180;
      const R2 = t2 * Math.PI / 180;
      const x1 = xPivot + L1 * Math.cos(R1);
      const y1 = yPivot + L1 * Math.sin(R1);
      const x2 = x1 + L2 * Math.cos(R1 + R2);
      const y2 = y1 + L2 * Math.sin(R1 + R2);
      return { x: x2, y: y2 };
    }

    updateTrench(depth);
    updatePile(pileHeight);
    setAngles(currentAngles.t1, currentAngles.t2, currentAngles.t3);

    async function digCycle() {
      const scoopX = trenchX - 8;
      const scoopY = groundY + depth + 10;
      const ikScoop = solveIK(scoopX, scoopY);
      const scoopAngles = { t1: ikScoop.theta1Deg, t2: ikScoop.theta2Deg, t3: 90 };
      await animateAngles(currentAngles, scoopAngles, descendMs);

      const curlAngles = { t1: scoopAngles.t1, t2: scoopAngles.t2, t3: 150 };
      await animateAngles(currentAngles, curlAngles, curlMs);
      await new Promise(r => setTimeout(r, 80));

      const liftTargetX = xPivot + 60;
      const liftTargetY = yPivot - 20 - Math.min(20, depth / 6);
      const ikLift = solveIK(liftTargetX, liftTargetY);
      const liftAngles = { t1: ikLift.theta1Deg, t2: ikLift.theta2Deg, t3: 160 };
      await animateAngles(currentAngles, liftAngles, liftMs);

      const pileX = trenchX + 140;
      const pileY = groundY - pileHeight + 6;
      const ikPile = solveIK(pileX - 10, pileY - 6);
      const overPileAngles = { t1: ikPile.theta1Deg, t2: ikPile.theta2Deg, t3: 150 };
      await animateAngles(currentAngles, overPileAngles, liftMs);

      const dumpAngles = { t1: overPileAngles.t1, t2: overPileAngles.t2, t3: 20 };
      await animateAngles(currentAngles, dumpAngles, dumpMs);

      const tip = bucketTipFromAngles(currentAngles.t1, currentAngles.t2, currentAngles.t3);
      flingDirt(8 + Math.floor(Math.random()*6), tip);

      updatePile(pileHeight + scoopStep * 0.55);
      updateTrench(depth + scoopStep);

      await new Promise(r => setTimeout(r, pauseMs));

      const idle = { t1: -20, t2: 35, t3: 90 };
      await animateAngles(currentAngles, idle, resetMs);

      if (depth >= maxDepth) {
        await new Promise(r => setTimeout(r, 300));
        updateTrench(10);
        updatePile(6);
      }

      await new Promise(r => setTimeout(r, 250));
      requestAnimationFrame(digCycle);
    }

    requestAnimationFrame(digCycle);
  </script>
</body>
</html>
